#!/usr/bin/env coffee

config = require '../lib/config/config'
config.load()

createMailr = ->
  Mailr = require '../lib/mailr'
  new Mailr()

nomnom = require 'nomnom'
nomnom.script('mailr')
nomnom.command('send')
  .options
    account:
      abbr: 'a'
      metavar: 'ACCOUNT'
      help: 'the account from which to send'
    emailFile:
      position: 1
      help: 'name of email file to send'
      required: true
  .help("send an email")
  .callback (opts) ->
    sender = require '../lib/sender'
    console.log "Sending..."
    sender.send(filename: opts.emailFile, account: opts.account) \
      .then (response) ->
        console.log response
      .fail (err) ->
        console.log "ERROR: #{err}"

nomnom.command('contacts')
  .options
    account:
      abbr: 'a'
      metavar: 'ACCOUNT'
      help: 'the account from which to send'
    update:
      abbr: 'u'
      flag: true
      help: 'updates the local contacts file'
  .help("gets the contacts")
  .callback (opts) ->
    mailr = createMailr()
    if opts.update
      mailr.updateContacts opts.account, (err, contacts) ->
        if err?
          console.log "ERROR: #{err}"
        else
          for contact in contacts
            console.log contact

nomnom.command('addresses')
  .help("shows the available from addresses")
  .callback ->
    for address in config.getFromAddresses()
      console.log address


nomnom.parse()
